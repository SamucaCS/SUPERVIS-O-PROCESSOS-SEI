<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Resultados – Visitas e Apoio Presencial (Supervisor)</title>
    <style>
        :root {
            --bg: #0f172a;
            --card: #111827;
            --muted: #94a3b8;
            --text: #e5e7eb;
            --accent: #22d3ee;
            --danger: #ef4444;
            --radius: 16px
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            margin: 0
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
            background: linear-gradient(135deg, #0b1025 0%, #0f172a 40%, #0b2530 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 24px
        }

        .container {
            max-width: 1100px;
            margin: 0 auto
        }

        header {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-bottom: 12px
        }

        h1 {
            font-size: 1.35rem;
            margin: 0
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, .04), rgba(0, 0, 0, .12));
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 16px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, .35);
            margin-bottom: 16px
        }

        .toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            padding: 12px;
            border-top: 1px solid rgba(255, 255, 255, .1)
        }

        .toolbar .grow {
            flex: 1
        }

        .toolbar input {
            max-width: 340px;
            background: #0b1226;
            border: 1px solid rgba(255, 255, 255, .1);
            color: var(--text);
            padding: 10px;
            border-radius: 12px
        }

        select {
            background: #0b1226;
            border: 1px solid rgba(255, 255, 255, .1);
            color: var(--text);
            padding: 10px;
            border-radius: 12px
        }

        .pill {
            padding: 4px 8px;
            border-radius: 999px;
            background: #0c1a34;
            border: 1px solid rgba(255, 255, 255, .12);
            font-size: .78rem
        }

        .table-wrap {
            overflow: auto
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            padding: 12px
        }

        thead th {
            font-size: .8rem;
            color: var(--muted);
            text-align: left;
            font-weight: 600;
            padding: 0 12px;
            white-space: nowrap
        }

        tbody tr {
            background: #0b1226;
            border: 1px solid rgba(255, 255, 255, .06)
        }

        tbody td {
            padding: 12px;
            border-top: 1px solid rgba(255, 255, 255, .06);
            border-bottom: 1px solid rgba(255, 255, 255, .06);
            vertical-align: top
        }

        tbody td:first-child {
            border-left: 1px solid rgba(255, 255, 255, .06);
            border-top-left-radius: 12px;
            border-bottom-left-radius: 12px
        }

        tbody td:last-child {
            border-right: 1px solid rgba(255, 255, 255, .06);
            border-top-right-radius: 12px;
            border-bottom-right-radius: 12px
        }

        .actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap
        }

        button,
        .btn {
            border: 0;
            cursor: pointer;
            border-radius: 12px;
            padding: 10px 14px;
            font-weight: 700
        }

        .btn {
            display: inline-block;
            text-decoration: none
        }

        .btn-secondary {
            background: #0b1226;
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, .15)
        }

        .btn-danger {
            background: var(--danger);
            color: #fff
        }

        .btn-small {
            padding: 6px 10px;
            font-weight: 600;
            border-radius: 10px
        }

        .empty {
            text-align: center;
            color: var(--muted);
            padding: 20px;
            border-top: 1px dashed rgba(255, 255, 255, .18)
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .6);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 999
        }

        .modal.open {
            display: flex
        }

        .modal-card {
            width: 100%;
            max-width: 540px;
            background: linear-gradient(180deg, rgba(255, 255, 255, .06), rgba(0, 0, 0, .18));
            border: 1px solid rgba(255, 255, 255, .12);
            border-radius: 18px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, .5);
            padding: 16px
        }

        .modal-card h2 {
            margin: 0 0 8px;
            font-size: 1.05rem
        }

        .modal-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px
        }

        .field {
            display: grid;
            gap: 6px
        }

        .field label {
            font-size: .85rem;
            color: var(--muted)
        }

        .field input,
        .field textarea {
            background: #0b1226;
            border: 1px solid rgba(255, 255, 255, .15);
            color: var(--text);
            padding: 10px;
            border-radius: 12px
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 10px
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Resultados – Visitas e Apoio Presencial (Supervisor)</h1>
            <div class="actions">
                <a class="btn btn-secondary" href="./supervisao-form.html">Cadastrar novo</a>
                <button id="printPage" class="btn-secondary">Imprimir</button>
                <button id="exportCsv" class="btn-secondary">Exportar CSV (aba ativa)</button>
            </div>
        </header>

        <section id="sec-visitas" class="card">
            <div class="toolbar">
                <div class="grow"><input id="v-search" type="search"
                        placeholder="Filtrar por supervisor, escola ou tema..." aria-label="Filtro de busca" /></div>
                <select id="v-filterMonth" aria-label="Filtrar por mês">
                    <option value="">Todos os meses</option>
                </select>
                <select id="v-filterSchool" aria-label="Filtrar por escola">
                    <option value="">Todas as escolas</option>
                </select>
                <span id="v-counter" class="pill">0 registros</span>
            </div>
            <div class="table-wrap">
                <table aria-describedby="v-counter">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Mês</th>
                            <th>Supervisor</th>
                            <th>Escola</th>
                            <th>Tema</th>
                            <th>Observações</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="v-tbody"></tbody>
                </table>
                <div id="v-empty" class="empty">Nenhum registro encontrado.</div>
            </div>
        </section>
    </div>

    <!-- Modal de edição -->
    <div id="editModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
        <div class="modal-card">
            <h2 id="editTitle">Editar registro</h2>
            <div class="modal-grid">
                <div class="field"><label for="fData">Data</label><input id="fData" type="date" /></div>
                <div class="field"><label for="fProf">Supervisor</label><input id="fProf" type="text" /></div>
                <div class="field"><label for="fEscola">Escola</label><input id="fEscola" type="text" /></div>
                <div class="field"><label for="fTema">Tema</label><input id="fTema" type="text" /></div>
                <div class="field"><label for="fObs">Observações</label><textarea id="fObs" rows="4"></textarea></div>
            </div>
            <div class="modal-actions">
                <button id="btnCancel" class="btn-secondary">Cancelar</button>
                <button id="btnSave" class="btn-secondary">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        /* ===== Supabase (PROJETO NOVO) ===== */
        const SUPABASE_URL = 'https://sfhxxkafubugqvaycnke.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaHh4a2FmdWJ1Z3F2YXljbmtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NTExMDEsImV4cCI6MjA3NzMyNzEwMX0.m7GJ-NVuouQsGdPTRGAx1bd6aPIP5-OWrdvoFTWSJU0';
        const sbHeaders = { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}`, 'Content-Type': 'application/json' };

        async function sbSelectAll() {
            const url = `${SUPABASE_URL}/rest/v1/supervisor_submissions?select=id,supervisor_nome,escola,data_visita,tema,observacoes&order=created_at.desc`;
            const r = await fetch(url, { headers: sbHeaders });
            if (!r.ok) throw new Error(`SELECT falhou: HTTP ${r.status}`);
            return r.json();
        }
        async function sbDelete(id) {
            const url = `${SUPABASE_URL}/rest/v1/supervisor_submissions?id=eq.${encodeURIComponent(id)}`;
            const r = await fetch(url, { method: 'DELETE', headers: sbHeaders });
            if (!r.ok) throw new Error(`DELETE falhou: HTTP ${r.status}`);
        }
        async function sbUpdate(id, payload) {
            const url = `${SUPABASE_URL}/rest/v1/supervisor_submissions?id=eq.${encodeURIComponent(id)}`;
            const r = await fetch(url, { method: 'PATCH', headers: { ...sbHeaders, Prefer: 'return=representation' }, body: JSON.stringify(payload) });
            const txt = await r.text(); let json = null; try { json = txt ? JSON.parse(txt) : null } catch { }
            if (!r.ok) throw new Error(json?.message || txt || `PATCH falhou: HTTP ${r.status}`);
            return json?.[0] || null;
        }

        /* ===== Util ===== */
        const $ = (s, sc = document) => sc.querySelector(s);
        const $$ = (s, sc = document) => Array.from(sc.querySelectorAll(s));
        const save = (k, d) => localStorage.setItem(k, JSON.stringify(d));
        const load = (k, f) => { try { return JSON.parse(localStorage.getItem(k)) ?? f } catch { return f } };
        const PT_BR_MESES = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        const fmt = {
            date(iso) { if (!iso) return ""; const d = new Date(iso + 'T00:00:00'); return String(d.getDate()).padStart(2, '0') + '/' + String(d.getMonth() + 1).padStart(2, '0') + '/' + d.getFullYear(); },
            month(iso) { if (!iso) return ""; return PT_BR_MESES[new Date(iso + 'T00:00:00').getMonth()]; }
        };
        const K_VISITAS = 'supervisor-registros-v1';

        /* ===== Sync banco -> storage ===== */
        async function syncFromSupabase() {
            const rows = await sbSelectAll();
            const items = rows.map(r => ({
                id: crypto?.randomUUID?.() || `id-${Math.random().toString(16).slice(2)}`,
                db_id: r.id,
                data: r.data_visita || '',
                professores: r.supervisor_nome || '',
                escola: r.escola || '',
                tema: r.tema || '',
                obs: r.observacoes || ''
            }));
            save(K_VISITAS, { items });
        }

        /* ===== Modal edição ===== */
        const modal = $('#editModal'); const fData = $('#fData'), fProf = $('#fProf'), fEscola = $('#fEscola'), fTema = $('#fTema'), fObs = $('#fObs');
        const btnCancel = $('#btnCancel'), btnSave = $('#btnSave'); let modalCtx = null;
        function openEdit(storageKey, index) {
            const state = load(storageKey, { items: [] }); const it = state.items[index] || {};
            fData.value = it.data || ''; fProf.value = it.professores || ''; fEscola.value = it.escola || ''; fTema.value = it.tema || ''; fObs.value = it.obs || '';
            modalCtx = { storageKey, index, original: it }; modal.classList.add('open');
        }
        function closeEdit() { modal.classList.remove('open'); modalCtx = null; }
        btnCancel.addEventListener('click', closeEdit);
        modal.addEventListener('click', e => { if (e.target === modal) closeEdit(); });

        btnSave.addEventListener('click', async () => {
            if (!modalCtx) return;
            const { storageKey, index } = modalCtx;
            const state = load(storageKey, { items: [] });
            const dval = (fData.value || '').trim();
            if (dval && !/^\d{4}-\d{2}-\d{2}$/.test(dval)) { alert('Data inválida. Use YYYY-MM-DD.'); return; }
            const updated = {
                ...(state.items[index] || {}),
                data: dval || '', professores: fProf.value || '', escola: fEscola.value || '', tema: fTema.value || '', obs: fObs.value || ''
            };

            try {
                if (updated.db_id) {
                    await sbUpdate(updated.db_id, {
                        data_visita: updated.data || null,
                        supervisor_nome: updated.professores || null,
                        escola: updated.escola || null,
                        tema: updated.tema || null,
                        observacoes: updated.obs || null
                    });
                }
            } catch (err) { alert('Falha ao salvar no banco: ' + err.message); return; }

            state.items[index] = updated; save(storageKey, state); mod.render(); closeEdit();
        });

        /* ===== Tabela ===== */
        function createReadModule(storageKey) {
            const els = {
                search: $('#v-search'), filterMonth: $('#v-filterMonth'), filterSchool: $('#v-filterSchool'),
                counter: $('#v-counter'), tbody: $('#v-tbody'), empty: $('#v-empty')
            };

            function getState() { return load(storageKey, { items: [] }); }
            function refreshSchoolFilter(state) {
                const selected = els.filterSchool.value;
                els.filterSchool.innerHTML = '<option value="">Todas as escolas</option>';
                const escolas = [...new Set(state.items.map(x => (x.escola || '').trim()).filter(Boolean))].sort((a, b) => a.localeCompare(b));
                escolas.forEach(es => { const o = document.createElement('option'); o.value = es; o.textContent = es; els.filterSchool.appendChild(o); });
                if (selected) els.filterSchool.value = selected;
            }
            function initFilters(state) {
                if (!els.filterMonth.dataset.ready) {
                    PT_BR_MESES.forEach((m, i) => { const o = document.createElement('option'); o.value = String(i + 1).padStart(2, '0'); o.textContent = m; els.filterMonth.appendChild(o); });
                    els.filterMonth.dataset.ready = '1';
                }
                refreshSchoolFilter(state);
            }
            function escapeHtml(s) { return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;').replace(/'/g, '&#039;'); }

            function render() {
                const state = getState(); initFilters(state);
                const q = (els.search.value || '').trim().toLowerCase();
                const mm = els.filterMonth.value; const es = (els.filterSchool.value || '').trim();
                const rows = state.items
                    .map((it, idx) => ({ it, idx }))
                    .filter(({ it }) => {
                        const matches = !q || [it.professores, it.escola, it.tema, it.obs].join(' ').toLowerCase().includes(q);
                        const monthOk = !mm || (it.data && it.data.split('-')[1] === mm);
                        const schoolOk = !es || it.escola === es;
                        return matches && monthOk && schoolOk;
                    })
                    .sort((a, b) => (a.it.data || '').localeCompare(b.it.data || ''));

                els.tbody.innerHTML = '';
                rows.forEach(({ it, idx }) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
            <td><span class="pill">${fmt.date(it.data)}</span></td>
            <td>${fmt.month(it.data)}</td>
            <td>${escapeHtml(it.professores || '')}</td>
            <td>${escapeHtml(it.escola || '')}</td>
            <td>${escapeHtml(it.tema || '')}</td>
            <td>${escapeHtml(it.obs || '')}</td>
            <td>
              <div class="actions">
                <button class="btn-small btn-secondary" data-cmd="edit" data-index="${idx}">Editar</button>
                <button class="btn-small btn-danger" data-cmd="del" data-index="${idx}">Excluir</button>
              </div>
            </td>`;
                    els.tbody.appendChild(tr);
                });

                els.empty.style.display = rows.length ? 'none' : 'block';
                els.counter.textContent = `${rows.length} registros`;
                refreshSchoolFilter(state);
            }

            els.search.addEventListener('input', render);
            els.filterMonth.addEventListener('change', render);
            els.filterSchool.addEventListener('change', render);

            els.tbody.addEventListener('click', async (ev) => {
                const btn = ev.target.closest('[data-cmd]'); if (!btn) return;
                const idx = Number(btn.getAttribute('data-index')); const cmd = btn.getAttribute('data-cmd');
                if (cmd === 'edit') { openEdit(storageKey, idx); return; }

                if (cmd === 'del') {
                    const state = load(storageKey, { items: [] }); const reg = state.items[idx];
                    const txt = reg ? `Confirma excluir o registro de "${reg.professores || '—'}" (${reg.escola || '—'})?` : 'Confirma excluir este registro?';
                    if (!confirm(txt)) return;

                    try { if (reg.db_id) await sbDelete(reg.db_id); } catch (err) { alert('Falha ao excluir no banco: ' + err.message); return; }
                    state.items.splice(idx, 1); save(storageKey, state); render();
                }
            });

            return { render };
        }

        // Boot
        let mod;
        (async function init() {
            try { await syncFromSupabase(); } catch (e) { console.error('Sync erro:', e); }
            mod = createReadModule(K_VISITAS);
            mod.render();
        })();

        // Export/Print
        document.getElementById('exportCsv').addEventListener('click', () => {
            const state = load(K_VISITAS, { items: [] });
            if (!state.items.length) { alert('Não há dados para exportar.'); return; }
            const headers = ['Data', 'Mês', 'Supervisor', 'Escola', 'Tema', 'Observações'];
            const rows = state.items
                .sort((a, b) => (a.data || '').localeCompare(b.data || ''))
                .map(it => [
                    (it.data ? (() => { const d = new Date(it.data + 'T00:00:00'); return String(d.getDate()).padStart(2, '0') + '/' + String(d.getMonth() + 1).padStart(2, '0') + '/' + d.getFullYear() })() : ''),
                    (it.data ? PT_BR_MESES[new Date(it.data + 'T00:00:00').getMonth()] : ''),
                    it.professores || '', it.escola || '', it.tema || '', it.obs || ''
                ]);
            const csv = [headers, ...rows].map(r => r.map(x => '"' + String(x).replace(/"/g, '""') + '"').join(',')).join('\n');
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'supervisor-registros.csv'; a.click(); URL.revokeObjectURL(url);
        });
        document.getElementById('printPage').addEventListener('click', () => window.print());
    </script>
</body>

</html>
