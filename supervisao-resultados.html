<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Resultados ‚Äì Visitas e Apoio Presencial (Supervisor)</title>
    <style>
        :root {
            --bg: #0f172a;
            --card: #111827;
            --muted: #94a3b8;
            --text: #e5e7eb;
            --accent: #22d3ee;
            --accent-2: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --radius: 16px
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
            background: linear-gradient(135deg, #0b1025 0%, #0f172a 40%, #0b2530 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 24px;
        }

        .container {
            max-width: 1080px;
            margin: 0 auto;
        }

        header {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        h1 {
            font-size: 1.35rem;
            margin: 0;
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, .04), rgba(0, 0, 0, .12));
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: var(--radius);
            box-shadow: 0 6px 24px rgba(0, 0, 0, .35);
            margin-bottom: 16px;
            padding: 16px;
        }

        .card--hidden {
            display: none;
        }

        .links {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        a.btn {
            display: inline-block;
            text-decoration: none;
            border-radius: 12px;
            padding: 8px 14px;
            font-size: .9rem;
            font-weight: 600;
        }

        .btn-primary {
            background: var(--accent);
            color: #03222c;
        }

        .btn-secondary {
            background: #0b1226;
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, .15);
        }

        .btn-danger {
            background: var(--danger);
            color: #fff;
            border: 0;
        }

        .table-wrapper {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.88rem;
        }

        thead {
            background: rgba(15, 23, 42, 0.9);
        }

        th,
        td {
            padding: 10px 8px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            text-align: left;
            vertical-align: top;
        }

        th {
            font-weight: 600;
            color: var(--muted);
            white-space: nowrap;
        }

        tbody tr:hover {
            background: rgba(15, 23, 42, 0.85);
        }

        .pill-tema {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(34, 211, 238, 0.1);
            border: 1px solid rgba(34, 211, 238, 0.3);
            font-size: 0.75rem;
            color: #a5f3fc;
        }

        .pill-escola {
            font-size: 0.8rem;
            color: #e5e7eb;
        }

        .col-small {
            width: 1%;
            white-space: nowrap;
        }

        .badge-empty {
            font-size: 0.75rem;
            color: var(--muted);
            font-style: italic;
        }

        .actions-cell button {
            border-radius: 10px;
            border: 0;
            padding: 6px 10px;
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            margin-right: 4px;
        }

        .actions-cell .edit {
            background: rgba(34, 197, 94, .1);
            color: #6ee7b7;
            border: 1px solid rgba(34, 197, 94, .4);
        }

        .actions-cell .delete {
            background: rgba(239, 68, 68, .1);
            color: #fecaca;
            border: 1px solid rgba(239, 68, 68, .4);
        }

        .grid {
            display: grid;
            gap: 12px;
            grid-template-columns: repeat(12, 1fr);
        }

        .col-6 {
            grid-column: span 6;
        }

        .col-3 {
            grid-column: span 3;
        }

        .col-12 {
            grid-column: span 12;
        }

        @media (max-width: 860px) {

            .col-6,
            .col-3 {
                grid-column: span 12;
            }
        }

        label {
            display: block;
            font-size: .88rem;
            color: var(--muted);
            margin: 2px 0 6px;
        }

        input,
        textarea,
        select {
            width: 100%;
            background: #0b1226;
            border: 1px solid rgba(255, 255, 255, .1);
            color: var(--text);
            padding: 10px;
            border-radius: 12px;
            outline: none;
            font-size: 0.9rem;
        }

        textarea {
            min-height: 70px;
            resize: vertical;
        }

        .actions-form {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .ok {
            display: none;
            margin-top: 10px;
            color: #10b981;
            font-size: 0.88rem;
        }

        .empty-state {
            padding: 8px 0;
            font-size: 0.9rem;
            color: var(--muted);
        }

        /* ===== FILTRO DE SUPERVISOR ===== */
        .filtro {
            margin-bottom: 14px;
            padding: 10px 12px;
            border-radius: 14px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.45);
        }

        .filtro-label {
            font-size: 0.8rem;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .filtro-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filtro-row input {
            flex: 1 1 220px;
        }

        .filtro-info {
            margin-top: 6px;
            font-size: 0.78rem;
            color: #7dd3fc;
        }

        .filtro-info strong {
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Resultados ‚Äì Visitas e Apoio Presencial (Supervisor)</h1>
            <div class="links">
                <a class="btn btn-secondary" href="./supervisao-form.html">‚Üê Voltar ao cadastro</a>
            </div>
        </header>

        <!-- LISTAGEM -->
        <section class="card">
            <h2 style="margin:0 0 12px;font-size:1rem">Registros lan√ßados</h2>

            <!-- FILTRO POR SUPERVISOR -->
            <div class="filtro">
                <div class="filtro-label">Filtrar por nome de supervisor</div>
                <div class="filtro-row">
                    <input id="filtro-supervisor" type="text"
                        placeholder="Digite o nome do supervisor, ex.: Ana, Jo√£o..." />
                    <button type="button" id="btn-limpar-filtro" class="btn-secondary"
                        style="padding:8px 12px;font-size:0.8rem;">
                        Limpar filtro
                    </button>
                </div>
                <p id="filtro-info" class="filtro-info"></p>
            </div>

            <div id="estado-vazio" class="empty-state" style="display:none">
                Nenhum registro encontrado. Volte ao cadastro para lan√ßar a primeira visita. üôÇ
            </div>

            <div class="table-wrapper">
                <table id="tabela-visitas">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Escola</th>
                            <th>Supervisor</th>
                            <th>Tema</th>
                            <th>Observa√ß√µes</th>
                            <th class="col-small">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- preenchido via JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- EDI√á√ÉO -->
        <section id="card-edicao" class="card card--hidden" aria-labelledby="titulo-edicao">
            <h2 id="titulo-edicao" style="margin:0 0 12px;font-size:1rem">Editar registro</h2>
            <form id="form-edicao">
                <input type="hidden" id="edit-id" name="id" />
                <div class="grid">
                    <div class="col-6">
                        <label for="edit-supervisor">Supervisor</label>
                        <input id="edit-supervisor" name="supervisor_nome" type="text" required />
                    </div>
                    <div class="col-3">
                        <label for="edit-data">Data</label>
                        <input id="edit-data" name="data_visita" type="date" required />
                    </div>
                    <div class="col-3">
                        <label for="edit-escola">Escola</label>
                        <input id="edit-escola" name="escola" type="text" required />
                    </div>
                    <div class="col-12">
                        <label for="edit-tema">Tema</label>
                        <input id="edit-tema" name="tema" type="text" required />
                    </div>
                    <div class="col-12">
                        <label for="edit-obs">Observa√ß√µes (opcional)</label>
                        <textarea id="edit-obs" name="observacoes"></textarea>
                    </div>
                </div>
                <div class="actions-form">
                    <button type="submit" class="btn-primary">Salvar altera√ß√µes</button>
                    <button type="button" id="btn-cancelar-edicao" class="btn-secondary">Cancelar</button>
                </div>
                <p class="ok" id="ok-edicao">‚úì Registro atualizado com sucesso.</p>
            </form>
        </section>
    </div>

    <script>
        // ===== Supabase (mesmo projeto/tabela do formul√°rio) =====
        const SUPABASE_URL = 'https://sfhxxkafubugqvaycnke.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmaHh4a2FmdWJ1Z3F2YXljbmtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NTExMDEsImV4cCI6MjA3NzMyNzEwMX0.m7GJ-NVuouQsGdPTRGAx1bd6aPIP5-OWrdvoFTWSJU0';

        const headersBase = {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`
        };

        let registros = [];
        let filtroSupervisor = '';

        function formatarData(iso) {
            if (!iso) return '';
            const s = iso.toString().slice(0, 10);
            const [y, m, d] = s.split('-');
            if (!y || !m || !d) return iso;
            return `${d}/${m}/${y}`;
        }

        async function carregarRegistros() {
            const tbody = document.querySelector('#tabela-visitas tbody');
            const vazio = document.getElementById('estado-vazio');
            tbody.innerHTML = '<tr><td colspan="6">Carregando...</td></tr>';

            try {
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/supervisor_submissions?select=*&order=data_visita.desc,created_at.desc`,
                    { headers: headersBase }
                );

                const text = await res.text();
                let json;
                try { json = text ? JSON.parse(text) : []; } catch { json = []; }

                if (!res.ok) {
                    console.error('Erro ao carregar:', text);
                    tbody.innerHTML = `<tr><td colspan="6">Erro ao carregar registros.</td></tr>`;
                    return;
                }

                registros = json || [];
                renderizarTabela();
                vazio.style.display = registros.length === 0 ? 'block' : 'none';
            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="6">Erro de conex√£o ao carregar registros.</td></tr>`;
            }
        }

        function obterListaFiltrada() {
            if (!filtroSupervisor) return registros;

            const termo = filtroSupervisor.toLowerCase();
            return registros.filter(r =>
                (r.supervisor_nome || '').toLowerCase().includes(termo)
            );
        }

        function renderizarTabela() {
            const tbody = document.querySelector('#tabela-visitas tbody');
            tbody.innerHTML = '';

            const lista = obterListaFiltrada();

            if (!lista.length) {
                tbody.innerHTML = '<tr><td colspan="6">Nenhum registro encontrado para esse filtro.</td></tr>';
                return;
            }

            for (const r of lista) {
                const tr = document.createElement('tr');
                tr.dataset.id = r.id;

                tr.innerHTML = `
          <td>${formatarData(r.data_visita)}</td>
          <td><span class="pill-escola">${r.escola || ''}</span></td>
          <td>${r.supervisor_nome || ''}</td>
          <td>
            ${r.tema ? `<span class="pill-tema">${r.tema}</span>` : '<span class="badge-empty">Sem tema</span>'}
          </td>
          <td>
            ${r.observacoes ? r.observacoes.replace(/\n/g, '<br>') : '<span class="badge-empty">Sem observa√ß√µes</span>'}
          </td>
          <td class="actions-cell col-small">
            <button type="button" class="edit" data-action="edit">Editar</button>
            <button type="button" class="delete" data-action="delete">Excluir</button>
          </td>
        `;

                tbody.appendChild(tr);
            }
        }

        function atualizarInfoFiltro() {
            const info = document.getElementById('filtro-info');
            if (filtroSupervisor) {
                info.innerHTML = `Mostrando apenas registros cujo supervisor cont√©m: <strong>"${filtroSupervisor}"</strong>.`;
            } else {
                info.textContent = '';
            }
        }

        function abrirEdicao(id) {
            const registro = registros.find(r => String(r.id) === String(id));
            if (!registro) return;

            document.getElementById('edit-id').value = registro.id;
            document.getElementById('edit-supervisor').value = registro.supervisor_nome || '';
            document.getElementById('edit-escola').value = registro.escola || '';
            document.getElementById('edit-data').value = (registro.data_visita || '').toString().slice(0, 10);
            document.getElementById('edit-tema').value = registro.tema || '';
            document.getElementById('edit-obs').value = registro.observacoes || '';

            const cardEdicao = document.getElementById('card-edicao');
            cardEdicao.classList.remove('card--hidden');
            cardEdicao.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function fecharEdicao() {
            const cardEdicao = document.getElementById('card-edicao');
            cardEdicao.classList.add('card--hidden');
        }

        async function salvarEdicao(ev) {
            ev.preventDefault();
            const okMsg = document.getElementById('ok-edicao');

            const id = document.getElementById('edit-id').value;
            const supervisor_nome = document.getElementById('edit-supervisor').value.trim();
            const escola = document.getElementById('edit-escola').value.trim();
            const data_visita = document.getElementById('edit-data').value;
            const tema = document.getElementById('edit-tema').value.trim();
            const observacoes = document.getElementById('edit-obs').value.trim() || null;

            const payload = { supervisor_nome, escola, data_visita, tema, observacoes };

            try {
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/supervisor_submissions?id=eq.${encodeURIComponent(id)}`,
                    {
                        method: 'PATCH',
                        headers: {
                            ...headersBase,
                            'Content-Type': 'application/json',
                            Prefer: 'return=representation'
                        },
                        body: JSON.stringify(payload)
                    }
                );

                const text = await res.text();
                let json;
                try { json = text ? JSON.parse(text) : null; } catch { }

                if (!res.ok) {
                    console.error('Erro update:', text);
                    alert('Falha ao atualizar registro: ' + (json?.message || text || res.status));
                    return;
                }

                okMsg.style.display = 'block';
                setTimeout(() => okMsg.style.display = 'none', 3000);

                await carregarRegistros();
                fecharEdicao();
            } catch (err) {
                console.error(err);
                alert('Erro de conex√£o ao atualizar registro.');
            }
        }

        async function excluirRegistro(id) {
            const confirmar = confirm('Tem certeza que deseja excluir este registro?');
            if (!confirmar) return;

            try {
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/supervisor_submissions?id=eq.${encodeURIComponent(id)}`,
                    {
                        method: 'DELETE',
                        headers: headersBase
                    }
                );

                const text = await res.text();
                let json;
                try { json = text ? JSON.parse(text) : null; } catch { }

                if (!res.ok) {
                    console.error('Erro delete:', text);
                    alert('Falha ao excluir registro: ' + (json?.message || text || res.status));
                    return;
                }

                registros = registros.filter(r => String(r.id) !== String(id));
                renderizarTabela();
            } catch (err) {
                console.error(err);
                alert('Erro de conex√£o ao excluir registro.');
            }
        }

        function wireEventos() {
            const tbody = document.querySelector('#tabela-visitas tbody');
            tbody.addEventListener('click', (ev) => {
                const btn = ev.target;
                if (!(btn instanceof HTMLElement)) return;

                const action = btn.dataset.action;
                if (!action) return;

                const tr = btn.closest('tr');
                if (!tr) return;
                const id = tr.dataset.id;
                if (!id) return;

                if (action === 'edit') {
                    abrirEdicao(id);
                } else if (action === 'delete') {
                    excluirRegistro(id);
                }
            });

            const formEdicao = document.getElementById('form-edicao');
            formEdicao.addEventListener('submit', salvarEdicao);

            const btnCancelar = document.getElementById('btn-cancelar-edicao');
            btnCancelar.addEventListener('click', fecharEdicao);

            // Filtro de supervisor
            const inputFiltro = document.getElementById('filtro-supervisor');
            const btnLimparFiltro = document.getElementById('btn-limpar-filtro');

            inputFiltro.addEventListener('input', () => {
                filtroSupervisor = inputFiltro.value.trim();
                renderizarTabela();
                atualizarInfoFiltro();
            });

            btnLimparFiltro.addEventListener('click', () => {
                filtroSupervisor = '';
                inputFiltro.value = '';
                renderizarTabela();
                atualizarInfoFiltro();
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            wireEventos();
            carregarRegistros();
        });
    </script>
</body>

</html>
